# setup : git remote add <environment> <git_url>

echo ''
echo "    DEPLOY WEBAPP to $1 ..."
echo ''

current_rev=`git rev-parse --short HEAD`

ruby build.rb

cp public/javascripts/app.js ../app.js
cp public/javascripts/app_android.js ../android_app.js
cp public/javascripts/app_wp.js ../wp_app.js
cp public/stylesheets/app_x1.css ../app_x1.css
cp public/stylesheets/app_x1.5.css ../app_x1.5.css
cp public/stylesheets/app_x2.css ../app_x2.css
cp public/stylesheets/app_android_x1.css ../app_android_x1.css
cp public/stylesheets/app_android_x1.5.css ../app_android_x1.5.css
cp public/stylesheets/app_android_x2.css ../app_android_x2.css
cp public/stylesheets/app_wp_x1.css ../app_wp_x1.css
cp public/stylesheets/app_wp_x1.5.css ../app_wp_x1.5.css
cp public/stylesheets/app_wp_x2.css ../app_wp_x2.css

git checkout $1
cp ../app.js public/javascripts/app.js
cp ../android_app.js public/javascripts/app_android.js
cp ../wp_app.js public/javascripts/app_wp.js
cp ../app_x1.css public/stylesheets/app_x1.css
cp ../app_x1.5.css public/stylesheets/app_x1.5.css
cp ../app_x2.css public/stylesheets/app_x2.css
cp ../app_android_x1.css public/stylesheets/app_android_x1.css
cp ../app_android_x1.5.css public/stylesheets/app_android_x1.5.css
cp ../app_android_x2.css public/stylesheets/app_android_x2.css
cp ../app_wp_x1.css public/stylesheets/app_wp_x1.css
cp ../app_wp_x1.5.css public/stylesheets/app_wp_x1.5.css
cp ../app_wp_x2.css public/stylesheets/app_wp_x2.css

previous_rev=`cat REVISION`
rm REVISION
echo $current_rev >> REVISION
git add REVISION

git commit -a -m "Compile new app version and set revision"
git push

git push $1 $1:master
heroku config:add RACK_ENV=$1 --remote $1

git checkout master
git submodule update

if [[ $1 = production ]] ; then
    domain="m.bonjourbonjour.net"
elif [[ $1 = staging ]] ; then
    domain="bb-webapp-html5-staging.herokuapp.com"
fi

codebase deploy $previous_rev $current_rev -s $domain -e $1 -b master -h bonjourbonjour.codebasehq.com -r bonjourbonjour:html5 --protocol https

rm ../app.js
rm ../android_app.js
rm ../wp_app.js
rm ../app_x1.css
rm ../app_x1.5.css
rm ../app_x2.css
rm ../app_android_x1.css
rm ../app_android_x1.5.css
rm ../app_android_x2.css
rm ../app_wp_x1.css
rm ../app_wp_x1.5.css
rm ../app_wp_x2.css
